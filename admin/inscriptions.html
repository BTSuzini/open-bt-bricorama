<!-- admin/inscriptions.html -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Inscriptions â€” Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">ğŸ› ï¸ Admin â€” Open BT Bricorama</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT Bricorama">
      </div>
    </div>

    <!-- âœ… Bandeau identique partout (souhait) -->
    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Encart "Zone" + onglets (souhait) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ›ï¸ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">GÃ©nÃ©ral</option>
        <option value="dh">Double Hommes</option>
        <option value="dd">Double Dames</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- =========================
       PANNEAU : INSCRIPTIONS
       (affichÃ© sous la zone)
  ========================== -->
  <section class="card" id="panelInscriptions" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ“ Inscriptions</h2>

    <p class="muted" id="currentState" style="margin:0;">Chargementâ€¦</p>
    <p class="muted" id="statusMsg" style="margin-top:8px;"></p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnNotOpen" style="font-weight:800; color:#111;">ğŸ’¤ Pas encore ouvertes</button>
      <button class="btn" id="btnOpen" style="font-weight:800; color:#111;">âœ… Ouvrir</button>
      <button class="btn" id="btnPause" style="font-weight:800; color:#111;">â¸ï¸ Suspendre</button>
      <button class="btn" id="btnClose" style="font-weight:800; color:#111;">ğŸ”’ ClÃ´turer</button>
    </div>

    <div class="grid" style="margin-top:12px;">
      <a class="btn" id="btnPublic" href="#" style="font-weight:800; color:#111;">ğŸ‘ï¸ Voir la page publique</a>
    </div>

    <p class="muted" style="margin-top:12px;">
      âš ï¸ Le public voit lâ€™Ã©tat (ouvertes / suspendues / clÃ´turÃ©es / pas encore ouvertes).<br>
      Les rÃ¨gles Firestore bloquent aussi lâ€™Ã©criture si ce nâ€™est pas â€œopenâ€.
    </p>
  </section>

  <!-- =========================
       MAINTENANCE : RAZ
  ========================== -->
  <section class="card" id="maintenanceUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§¹ Maintenance</h2>

    <p class="muted" style="margin:0;">
      Cette action supprime <b>toutes</b> les inscriptions (privÃ© + public) pour la zone choisie,
      et remet le statut Ã  <b>Pas encore ouvertes</b>.
      <br>âš ï¸ <b>IrrÃ©versible</b>.
    </p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnRAZ" style="font-weight:900; color:#111; border-color:#f1b2b2;">
        ğŸ§¨ RAZ â€” Supprimer toutes les inscriptions
      </button>
    </div>

    <p class="muted" id="razStatus" style="margin-top:10px;"></p>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, setDoc, onSnapshot, serverTimestamp,
    collection, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ----------------------------
  // Param + scope persistence
  // ----------------------------
  const params = new URLSearchParams(location.search);
  const urlScope = (params.get("scope") || "").toLowerCase();

  const LS_KEY = "openbt_admin_scope";

  function normalizeScope(x){
    if(x === "dh" || x === "dd" || x === "general") return x;
    return "general";
  }

  // scope initial : URL > localStorage > general
  let scope = normalizeScope(urlScope);
  if(!urlScope){
    try{
      const saved = localStorage.getItem(LS_KEY);
      if(saved) scope = normalizeScope(saved);
    }catch(e){}
  }

  // ----------------------------
  // DOM
  // ----------------------------
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const panelInscriptions = document.getElementById("panelInscriptions");
  const maintenanceUI = document.getElementById("maintenanceUI");

  const currentStateEl = document.getElementById("currentState");
  const statusMsgEl = document.getElementById("statusMsg");

  const btnNotOpen = document.getElementById("btnNotOpen");
  const btnOpen = document.getElementById("btnOpen");
  const btnPause = document.getElementById("btnPause");
  const btnClose = document.getElementById("btnClose");
  const btnPublic = document.getElementById("btnPublic");

  const btnRAZ = document.getElementById("btnRAZ");
  const razStatus = document.getElementById("razStatus");

  // config doc unique Open BT
  const cfgRef = doc(db, "config", "open");

  // mapping champ gate selon scope
  function gateFieldForScope(sc){
    if(sc === "dh") return "inscriptionsDHState";
    if(sc === "dd") return "inscriptionsDDState";
    return null;
  }

  function labelScope(sc){
    if(sc === "dh") return "Double Hommes";
    if(sc === "dd") return "Double Dames";
    return "GÃ©nÃ©ral";
  }

  function publicUrlForScope(sc){
    if(sc === "dh") return "../dh/inscriptions.html";
    if(sc === "dd") return "../dd/inscriptions.html";
    return "../pages/infos.html";
  }

  function labelFor(state){
    switch(state){
      case "not_open": return "ğŸ’¤ Pas encore ouvertes";
      case "open": return "âœ… Ouvertes";
      case "paused": return "â¸ï¸ Suspendues";
      case "closed": return "ğŸ”’ ClÃ´turÃ©es";
      default: return "â€”";
    }
  }

  function publicMessage(state){
    switch(state){
      case "not_open": return "Le public voit : â€œLes inscriptions ne sont pas encore ouvertes.â€";
      case "open": return "Le public voit : â€œInscriptions ouvertes âœ…â€ (formulaire actif).";
      case "paused": return "Le public voit : â€œInscriptions suspendues â¸ï¸â€ (formulaire bloquÃ©).";
      case "closed": return "Le public voit : â€œInscriptions clÃ´turÃ©es ğŸ”’â€ (formulaire bloquÃ©).";
      default: return "";
    }
  }

  function setButtonsDisabled(disabled){
    [btnNotOpen, btnOpen, btnPause, btnClose, btnRAZ].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle("disabled", disabled);
    });
  }

  // ----------------------------
  // Tabs (mÃªmes partout)
  // ----------------------------
  function tabHref(page, sc){
    return `${page}?scope=${encodeURIComponent(sc)}`;
  }

  function setTabs(sc){
    tabsEl.innerHTML = "";
    panelInscriptions.style.display = "none";
    maintenanceUI.style.display = "none";

    // hint
    if(sc === "general"){
      hintEl.textContent = "Zone GÃ©nÃ©ral : gestion (ex : Infos).";
    } else {
      hintEl.textContent = `Zone ${labelScope(sc)} : inscriptions / Ã©quipes / tirage.`;
    }

    // tabs list
    const tabs = (sc === "general")
      ? [
          ["ğŸ“° Infos", tabHref("index.html", "general")],
          ["ğŸ“ Inscriptions", tabHref("inscriptions.html", "general")] // reste sur page, mais on garde cohÃ©rent
        ]
      : [
          ["ğŸ‘¥ Ã‰quipes", tabHref("equipes.html", sc)],
          ["ğŸ“ Inscriptions", tabHref("inscriptions.html", sc)],
          ["ğŸ² Tirage", tabHref("tirage.html", sc)]
        ];

    for(const [label, href] of tabs){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = href;
      a.textContent = label;

      // highlight current page (inscriptions)
      if(label.includes("Inscriptions")){
        a.setAttribute("aria-current", "page");
      }
      tabsEl.appendChild(a);
    }

    // show panels only for DH/DD (car "Inscriptions" n'a pas de sens en "GÃ©nÃ©ral")
    if(sc === "dh" || sc === "dd"){
      panelInscriptions.style.display = "block";
      maintenanceUI.style.display = "block";
    } else {
      // gÃ©nÃ©ral : on affiche un message simple
      panelInscriptions.style.display = "block";
      maintenanceUI.style.display = "none";
      currentStateEl.innerHTML = `Zone : <strong>${labelScope(sc)}</strong>`;
      statusMsgEl.textContent = "Cette page â€œInscriptionsâ€ ne sâ€™applique pas Ã  la zone GÃ©nÃ©ral. Utilise plutÃ´t lâ€™onglet â€œInfosâ€.";
      // disable buttons
      setButtonsDisabled(true);
      btnPublic.href = "../admin/index.html?scope=general";
      btnPublic.textContent = "â¡ï¸ Aller Ã  lâ€™admin (GÃ©nÃ©ral)";
    }
  }

  // ----------------------------
  // Gate state live
  // ----------------------------
  let unsubscribeCfg = null;
  let currentState = "not_open";

  function stopCfg(){
    if(unsubscribeCfg){
      unsubscribeCfg();
      unsubscribeCfg = null;
    }
  }

  function startCfg(sc){
    stopCfg();

    const field = gateFieldForScope(sc);
    if(!field){
      currentState = "not_open";
      return;
    }

    currentStateEl.textContent = "Chargementâ€¦";
    statusMsgEl.textContent = "";

    unsubscribeCfg = onSnapshot(cfgRef, (snap)=>{
      const d = snap.exists() ? (snap.data() || {}) : {};
      const state = (d[field] || "not_open");
      currentState = state;

      currentStateEl.innerHTML = `Zone : <strong>${labelScope(sc)}</strong> â€” Statut actuel : <strong>${labelFor(state)}</strong>`;
      statusMsgEl.textContent = publicMessage(state);

      btnPause.textContent = (state === "paused") ? "â–¶ï¸ RÃ©activer" : "â¸ï¸ Suspendre";
    }, (err)=>{
      console.error(err);
      currentStateEl.textContent = "âŒ Impossible de lire le statut (config/open).";
      statusMsgEl.textContent = "";
    });
  }

  async function setState(sc, next){
    const field = gateFieldForScope(sc);
    if(!field) return;

    if(next === "closed"){
      const ok = confirm("ClÃ´turer les inscriptions ?\n\nLe public verra â€œclÃ´turÃ©esâ€ et ne pourra plus sâ€™inscrire.");
      if(!ok) return;
    }
    if(next === "not_open"){
      const ok = confirm("Mettre â€œpas encore ouvertesâ€ ?\n\nLe public verra que ce nâ€™est pas ouvert, formulaire bloquÃ©.");
      if(!ok) return;
    }

    setButtonsDisabled(true);
    statusMsgEl.textContent = "Mise Ã  jourâ€¦";

    try{
      await setDoc(cfgRef, {
        [field]: next,
        updatedAt: serverTimestamp()
      }, { merge:true });

      statusMsgEl.textContent = "âœ… Statut mis Ã  jour.";
    }catch(e){
      console.error(e);
      statusMsgEl.textContent = "âŒ Erreur : impossible de mettre Ã  jour.";
    }finally{
      setButtonsDisabled(false);
    }
  }

  // ----------------------------
  // RAZ helpers
  // ----------------------------
  function colNamesForScope(sc){
    if(sc === "dh") return { priv: "inscriptions_dh_private", pub: "equipes_dh_public" };
    if(sc === "dd") return { priv: "inscriptions_dd_private", pub: "equipes_dd_public" };
    return null;
  }

  async function deleteCollectionInBatches(colName, batchSize=450){
    let deleted = 0;

    while(true){
      const snap = await getDocs(collection(db, colName));
      if(snap.empty) break;

      const docs = snap.docs.slice(0, batchSize);
      const batch = writeBatch(db);
      docs.forEach(d => batch.delete(d.ref));
      await batch.commit();

      deleted += docs.length;
      if(docs.length < batchSize) break;
    }

    return deleted;
  }

  async function doRAZ(sc){
    const cols = colNamesForScope(sc);
    const field = gateFieldForScope(sc);
    if(!cols || !field){
      alert("RAZ indisponible pour cette zone.");
      return;
    }

    const ok1 = confirm(
      "âš ï¸ RAZ INSCRIPTIONS\n\nCette action supprime TOUTES les inscriptions (privÃ© + public) pour : " + labelScope(sc) + ".\n\nContinuer ?"
    );
    if(!ok1) return;

    const typed = prompt('Tape exactement : RAZ\n\n(pour confirmer la suppression complÃ¨te)');
    if(typed !== "RAZ"){
      alert("AnnulÃ©.");
      return;
    }

    setButtonsDisabled(true);
    razStatus.textContent = "Suppression en coursâ€¦";

    try{
      // 1) remettre not_open avant nettoyage
      await setDoc(cfgRef, { [field]: "not_open", updatedAt: serverTimestamp() }, { merge:true });

      // 2) delete
      const delPub  = await deleteCollectionInBatches(cols.pub);
      const delPriv = await deleteCollectionInBatches(cols.priv);

      razStatus.textContent = `âœ… RAZ OK â€” supprimÃ©s : public=${delPub}, privÃ©=${delPriv}. Statut remis Ã  â€œPas encore ouvertesâ€.`;
      alert(`RAZ terminÃ© âœ…\n\nSupprimÃ©s :\n- Public: ${delPub}\n- PrivÃ©: ${delPriv}\n\nStatut : pas encore ouvertes`);
    }catch(e){
      console.error(e);
      razStatus.textContent = "âŒ Erreur pendant le RAZ. Voir console.";
      alert("Erreur pendant le RAZ âŒ\n\nOuvre la console pour le dÃ©tail.");
    }finally{
      setButtonsDisabled(false);
    }
  }

  // ----------------------------
  // Actions
  // ----------------------------
  btnNotOpen.onclick = ()=> setState(scope, "not_open");
  btnOpen.onclick = ()=> setState(scope, "open");
  btnPause.onclick = ()=>{
    if(currentState === "paused") setState(scope, "open");
    else setState(scope, "paused");
  };
  btnClose.onclick = ()=> setState(scope, "closed");

  btnRAZ.onclick = ()=> doRAZ(scope);

  btnPublic.onclick = (e)=>{
    e.preventDefault();
    window.location.href = publicUrlForScope(scope);
  };

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // ----------------------------
  // Guard admin + init
  // ----------------------------
  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  function applyScope(newScope){
    scope = normalizeScope(newScope);

    try{ localStorage.setItem(LS_KEY, scope); }catch(e){}

    // sync URL (sans recharger)
    const u = new URL(location.href);
    u.searchParams.set("scope", scope);
    history.replaceState({}, "", u.toString());

    scopeEl.value = scope;

    // tabs + panels
    setTabs(scope);

    // public link label
    if(scope === "dh" || scope === "dd"){
      btnPublic.textContent = "ğŸ‘ï¸ Voir la page publique";
      btnPublic.href = publicUrlForScope(scope);
      setButtonsDisabled(false);
      startCfg(scope);
    } else {
      stopCfg();
    }
  }

  scopeEl.onchange = ()=> applyScope(scopeEl.value);

  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminUI.style.display = "none";
    panelInscriptions.style.display = "none";
    maintenanceUI.style.display = "none";
    stopCfg();

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    adminUI.style.display = "block";
    applyScope(scope);
  });
</script>

</body>
</html>
