<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Inscriptions</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260220" />
</head>
<body>

<div id="adminHeader"></div>

<main class="container">

  <div id="adminZone"></div>

  <section class="card" id="pageContent" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ“ Inscriptions â€” Admin</h2>

    <p class="muted" id="scopeLine" style="margin:0;">Chargementâ€¦</p>

    <div class="grid" style="margin-top:12px;">
      <a class="btn" id="btnPublic" href="#" target="_blank" rel="noopener" style="font-weight:900; color:#111;">
        ğŸ‘€ Ouvrir la vue publique (inscriptions)
      </a>
    </div>

    <hr class="sep" />

    <h3 style="margin:0 0 10px;">ğŸ›ï¸ Statut des inscriptions</h3>

    <p class="muted" id="currentState" style="margin:0;">Chargementâ€¦</p>
    <p class="muted" id="statusMsg" style="margin-top:8px;"></p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnNotOpen" style="font-weight:800; color:#111;">ğŸ’¤ Pas encore ouvertes</button>
      <button class="btn" id="btnOpen" style="font-weight:800; color:#111;">âœ… Ouvrir</button>
      <button class="btn" id="btnSuspend" style="font-weight:800; color:#111;">â¸ï¸ Suspendre</button>
      <button class="btn" id="btnClose" style="font-weight:800; color:#111;">ğŸ”’ ClÃ´turer</button>
    </div>

    <p class="muted" style="margin-top:12px;">
      âš ï¸ Le public voit lâ€™Ã©tat (ouvertes / suspendues / clÃ´turÃ©es / pas encore ouvertes).<br>
      On raccordera ensuite la page publique DH/DD sur ce statut.
    </p>

    <hr class="sep" />

    <h3 style="margin:0 0 10px;">ğŸ§¹ Maintenance</h3>

    <p class="muted" style="margin:0;">
      Cette action supprime <b>toutes</b> les inscriptions du tournoi (privÃ© + public) pour la zone sÃ©lectionnÃ©e (DM ou DD)
      et remet le statut Ã  <b>Pas encore ouvertes</b>.
      <br>âš ï¸ <b>IrrÃ©versible</b>.
    </p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnRAZ" style="font-weight:900; color:#111; border-color:#f1b2b2;">
        ğŸ§¨ RAZ â€” Supprimer toutes les inscriptions
      </button>
    </div>

    <p class="muted" id="razStatus" style="margin-top:10px;"></p>
  </section>

</main>

<script type="module">
  import { renderAdminShell } from "../assets/js/admin-shell.js";
  import { auth, db } from "../assets/js/firebase.js";
  import { getRoleByEmail } from "../assets/js/session.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, setDoc, onSnapshot, serverTimestamp,
    collection, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  renderAdminShell({ active: "inscriptions", basePath: ".." });

  const pageContent = document.getElementById("pageContent");

  const params = new URLSearchParams(location.search);
  const scope = (params.get("scope") || "").toLowerCase(); // dh | dd
  const scopeLine = document.getElementById("scopeLine");

  const btnPublic = document.getElementById("btnPublic");

  const currentStateEl = document.getElementById("currentState");
  const statusMsgEl = document.getElementById("statusMsg");

  const btnNotOpen = document.getElementById("btnNotOpen");
  const btnOpen = document.getElementById("btnOpen");
  const btnSuspend = document.getElementById("btnSuspend");
  const btnClose = document.getElementById("btnClose");

  const btnRAZ = document.getElementById("btnRAZ");
  const razStatus = document.getElementById("razStatus");

  function labelScope(s){
    if(s === "dh") return "Double Messieurs (DM)";
    if(s === "dd") return "Double Dames (DD)";
    return "â€”";
  }

  // --- On stocke les Ã©tats dans config/open
  //     - inscriptionsDHState
  //     - inscriptionsDDState
  const cfgRef = doc(db, "config", "open");

  function stateKeyForScope(s){
    if(s === "dh") return "inscriptionsDHState";
    if(s === "dd") return "inscriptionsDDState";
    return null;
  }

  function labelFor(state){
    switch(state){
      case "not_open": return "ğŸ’¤ Pas encore ouvertes";
      case "open": return "âœ… Ouvertes";
      case "suspended": return "â¸ï¸ Suspendues";
      case "closed": return "ğŸ”’ ClÃ´turÃ©es";
      default: return "â€”";
    }
  }

  function publicMessage(state){
    switch(state){
      case "not_open": return "Le public voit : â€œLes inscriptions ne sont pas encore ouvertes.â€";
      case "open": return "Le public voit : â€œInscriptions ouvertes âœ…â€ (formulaire actif).";
      case "suspended": return "Le public voit : â€œInscriptions suspendues â¸ï¸â€ (formulaire bloquÃ©).";
      case "closed": return "Le public voit : â€œInscriptions clÃ´turÃ©es ğŸ”’â€ (formulaire bloquÃ©).";
      default: return "";
    }
  }

  function setButtonsDisabled(disabled){
    [btnNotOpen, btnOpen, btnSuspend, btnClose, btnRAZ].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle("disabled", disabled);
    });
  }

  let currentState = "not_open";

  async function setState(next){
    if(!key){
      alert("Choisis DM ou DD dans le menu â€œZoneâ€.");
      return;
    }

    if(next === "closed"){
      const ok = confirm("ClÃ´turer les inscriptions ?\n\nLe public verra â€œclÃ´turÃ©esâ€ et ne pourra plus sâ€™inscrire.");
      if(!ok) return;
    }
    if(next === "not_open"){
      const ok = confirm("Mettre â€œpas encore ouvertesâ€ ?\n\nLe public verra que ce nâ€™est pas ouvert, formulaire bloquÃ©.");
      if(!ok) return;
    }

    setButtonsDisabled(true);
    statusMsgEl.textContent = "Mise Ã  jourâ€¦";

    try{
      await setDoc(cfgRef, {
        [key]: next,
        updatedAt: serverTimestamp()
      }, { merge:true });

      statusMsgEl.textContent = "âœ… Statut mis Ã  jour.";
    }catch(e){
      console.error(e);
      statusMsgEl.textContent = "âŒ Erreur : impossible de mettre Ã  jour.";
    }finally{
      setButtonsDisabled(false);
    }
  }

  // --- RAZ : collections par scope
  function colsForScope(s){
    // Tu peux changer ces noms si tu prÃ©fÃ¨res autre chose.
    // Le but : 2 collections (privÃ©e + publique) par tournoi.
    if(s === "dh"){
      return {
        privateCol: "inscriptions_dh_private",
        publicCol: "equipes_dh_public"
      };
    }
    if(s === "dd"){
      return {
        privateCol: "inscriptions_dd_private",
        publicCol: "equipes_dd_public"
      };
    }
    return null;
  }

  async function deleteCollectionInBatches(colName, batchSize=450){
    let deleted = 0;
    while(true){
      const snap = await getDocs(collection(db, colName));
      if(snap.empty) break;

      const docs = snap.docs.slice(0, batchSize);
      const batch = writeBatch(db);
      docs.forEach(d => batch.delete(d.ref));
      await batch.commit();

      deleted += docs.length;
      if(docs.length < batchSize) break;
    }
    return deleted;
  }

  async function doRAZ(){
    if(!key){
      alert("Choisis DM ou DD dans le menu â€œZoneâ€.");
      return;
    }

    const ok1 = confirm(
      "âš ï¸ RAZ INSCRIPTIONS\n\nCette action supprime TOUTES les inscriptions (privÃ© + public) pour " + labelScope(scope) + ".\n\nContinuer ?"
    );
    if(!ok1) return;

    const typed = prompt('Tape exactement : RAZ\n\n(pour confirmer la suppression complÃ¨te)');
    if(typed !== "RAZ"){
      alert("AnnulÃ©.");
      return;
    }

    const cols = colsForScope(scope);
    if(!cols){
      alert("Scope invalide. Choisis DM ou DD.");
      return;
    }

    setButtonsDisabled(true);
    razStatus.textContent = "Suppression en coursâ€¦";

    try{
      // Remet le statut Ã  not_open dâ€™abord (safe)
      await setDoc(cfgRef, { [key]: "not_open", updatedAt: serverTimestamp() }, { merge:true });

      const delPublic  = await deleteCollectionInBatches(cols.publicCol);
      const delPrivate = await deleteCollectionInBatches(cols.privateCol);

      razStatus.textContent = `âœ… RAZ OK â€” supprimÃ©s : public=${delPublic}, privÃ©=${delPrivate}. Statut remis Ã  â€œPas encore ouvertesâ€.`;
      alert(`RAZ terminÃ© âœ…\n\nSupprimÃ©s :\n- Public: ${delPublic}\n- PrivÃ©: ${delPrivate}\n\nStatut : pas encore ouvertes`);
    }catch(e){
      console.error(e);
      razStatus.textContent = "âŒ Erreur pendant le RAZ. Voir console.";
      alert("Erreur pendant le RAZ âŒ\n\nOuvre la console pour le dÃ©tail.");
    }finally{
      setButtonsDisabled(false);
    }
  }

  btnNotOpen.onclick = ()=> setState("not_open");
  btnOpen.onclick = ()=> setState("open");
  btnSuspend.onclick = ()=>{
    if(currentState === "suspended") setState("open");
    else setState("suspended");
  };
  btnClose.onclick = ()=> setState("closed");
  btnRAZ.onclick = doRAZ;

  // --- Lien vue publique (on utilisera dh/inscriptions.html et dd/inscriptions.html)
  function setPublicLink(){
    if(scope === "dh"){
      btnPublic.href = "../dh/inscriptions.html";
      btnPublic.textContent = "ğŸ‘€ Ouvrir la vue publique (DM)";
      return;
    }
    if(scope === "dd"){
      btnPublic.href = "../dd/inscriptions.html";
      btnPublic.textContent = "ğŸ‘€ Ouvrir la vue publique (DD)";
      return;
    }
    btnPublic.href = "#";
    btnPublic.textContent = "ğŸ‘€ Ouvrir la vue publique (inscriptions)";
  }

  // scope key
  const key = stateKeyForScope(scope);

  // guard admin + live state
  onAuthStateChanged(auth, async (user)=>{
    pageContent.style.display = "none";

    if(!user) return;
    const role = await getRoleByEmail(user.email);
    if(role !== "admin") return;

    pageContent.style.display = "block";

    setPublicLink();

    if(!key){
      scopeLine.textContent = "Choisis DM ou DD dans le menu â€œZoneâ€.";
      currentStateEl.textContent = "â€”";
      statusMsgEl.textContent = "";
      setButtonsDisabled(true);
      return;
    }

    scopeLine.textContent = `Zone sÃ©lectionnÃ©e : ${labelScope(scope)}`;
    setButtonsDisabled(false);

    onSnapshot(cfgRef, (snap)=>{
      const data = snap.exists() ? (snap.data() || {}) : {};
      const state = (data[key] || "not_open");
      currentState = state;

      currentStateEl.innerHTML = `Statut actuel : <strong>${labelFor(state)}</strong>`;
      statusMsgEl.textContent = publicMessage(state);

      btnSuspend.textContent = (state === "suspended") ? "â–¶ï¸ RÃ©activer" : "â¸ï¸ Suspendre";
    }, (err)=>{
      console.error(err);
      currentStateEl.textContent = "âŒ Impossible de lire le statut.";
      statusMsgEl.textContent = "";
    });
  });
</script>

</body>
</html>
