<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260220" />
</head>
<body>

<div id="adminHeader"></div>

<main class="container">

  <div id="adminZone"></div>

  <!-- Contenu aprÃ¨s encart "Zone" -->
  <section class="card" id="pageContent" style="display:none;">

    <!-- Bloc GÃ©nÃ©ral -->
    <div id="panelGeneral" style="display:none;">
      <h2 style="margin:0 0 10px;">ğŸ“° Infos (admin)</h2>

      <form id="infoForm" class="form" autocomplete="off">
        <div class="field">
          <label for="infoTitle">Titre *</label>
          <input id="infoTitle" name="infoTitle" required maxlength="80" placeholder="Ex : Inscriptions ouvertes âœ…">
        </div>

        <div class="field">
          <label for="infoText">Texte *</label>
          <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
            placeholder="Texte (emojis ok ğŸ˜„)"></textarea>
        </div>

        <button class="btn" id="publishBtn" type="submit" style="font-weight:800; color:#111;">âœ… Publier</button>
        <p class="muted" id="adminStatus" role="status" aria-live="polite" style="margin:8px 0 0;"></p>
      </form>

      <hr class="sep" />

      <p class="muted" id="infosCount" style="margin:0;">Chargementâ€¦</p>
      <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
    </div>

    <!-- Bloc DM/DD (raccourcis) -->
    <div id="panelScope" style="display:none;">
      <h2 style="margin:0 0 10px;">ğŸ›ï¸ Administration â€” Tournoi</h2>
      <p class="muted" id="scopeHint" style="margin:0;">
        Choisis DM ou DD dans le menu dÃ©roulant â€œZoneâ€.
      </p>

      <div class="grid" style="margin-top:12px;">
        <a class="btn" id="goEquipes" href="#" style="font-weight:900; color:#111;">ğŸ‘¥ Ã‰quipes</a>
        <a class="btn" id="goInscriptions" href="#" style="font-weight:900; color:#111;">ğŸ“ Inscriptions</a>
        <a class="btn" id="goTirage" href="#" style="font-weight:900; color:#111;">ğŸ² Tirage</a>
      </div>

      <p class="muted" style="margin-top:10px;">
        (La gestion dÃ©taillÃ©e est dans les pages dÃ©diÃ©es, accessibles via les onglets.)
      </p>
    </div>

  </section>

</main>

<script type="module">
  import { renderAdminShell } from "../assets/js/admin-shell.js";
  import { auth, db } from "../assets/js/firebase.js";
  import { getRoleByEmail } from "../assets/js/session.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, addDoc, deleteDoc, updateDoc,
    doc, getDoc,
    serverTimestamp,
    query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  renderAdminShell({ active: "home", basePath: ".." });

  const pageContent = document.getElementById("pageContent");
  const panelGeneral = document.getElementById("panelGeneral");
  const panelScope = document.getElementById("panelScope");

  const params = new URLSearchParams(location.search);
  const scope = (params.get("scope") || "general").toLowerCase();

  // --- Infos (gÃ©nÃ©ral)
  const COL_INFOS = "infos";
  const infoForm = document.getElementById("infoForm");
  const publishBtn = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");
  const infosCount = document.getElementById("infosCount");
  const infosList = document.getElementById("infosList");
  let unsubscribeInfos = null;

  function esc(str){
    return (str || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "â€”";
      return d.toLocaleString("fr-FR", { year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit" });
    }catch{ return "â€”"; }
  }

  function stopInfos(){
    if(unsubscribeInfos){
      unsubscribeInfos();
      unsubscribeInfos = null;
    }
  }

  function startInfos(){
    if(unsubscribeInfos) return;

    infosCount.textContent = "Chargementâ€¦";
    infosList.innerHTML = "";

    const q = query(collection(db, COL_INFOS), orderBy("createdAt","desc"));
    unsubscribeInfos = onSnapshot(q, (snap)=>{
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      infosCount.textContent = `ğŸ“Œ ${items.length} info${items.length>1?"s":""}`;
      infosList.innerHTML = "";

      if(items.length === 0){
        infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info publiÃ©e.</p>`;
        return;
      }

      for(const it of items){
        const title = esc(it.title);
        const text = esc(it.text).replaceAll("\n","<br>");
        const date = fmtDate(it.createdAt);

        const card = document.createElement("div");
        card.className = "card";
        card.style.margin = "0";
        card.innerHTML = `
          <div style="display:flex; gap:12px; justify-content:space-between; align-items:flex-start;">
            <div style="min-width:0;">
              <div style="font-weight:900;">${title}</div>
              <div class="muted" style="margin-top:6px;">ğŸ—“ï¸ ${date}</div>
              <div style="margin-top:8px; line-height:1.45;">${text}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; flex:0 0 auto;">
              <button class="btn" data-edit="${it.id}" style="font-weight:800; color:#111;">âœï¸ Modifier</button>
              <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">ğŸ—‘ï¸ Supprimer</button>
            </div>
          </div>
        `;
        infosList.appendChild(card);
      }

      infosList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.del;
          const ok = confirm("Supprimer cette info ?\n\nâš ï¸ Action irrÃ©versible.");
          if(!ok) return;
          await deleteDoc(doc(db, COL_INFOS, id));
        };
      });

      infosList.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.edit;
          const ref = doc(db, COL_INFOS, id);
          const s = await getDoc(ref);
          if(!s.exists()) return;
          const cur = s.data();

          const newTitle = prompt("Modifier le titre :", cur.title || "");
          if(newTitle === null) return;
          const newText = prompt("Modifier le texte :", cur.text || "");
          if(newText === null) return;

          await updateDoc(ref, { title: newTitle.trim(), text: newText.trim() });
        };
      });

    }, (err)=>{
      console.error(err);
      infosCount.textContent = "âŒ Impossible de charger les infos.";
    });
  }

  // publish
  infoForm?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publicationâ€¦";
    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text  = (infoForm.infoText.value || "").trim();
      if(!title || !text) throw new Error("Titre et texte obligatoires.");

      await addDoc(collection(db, COL_INFOS), { title, text, createdAt: serverTimestamp() });
      infoForm.reset();
      adminStatus.textContent = "âœ… PubliÃ© !";
    }catch(err){
      console.error(err);
      adminStatus.textContent = "âŒ Erreur : " + (err?.message || "Impossible de publier.");
    }finally{
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });

  // --- Raccourcis DM/DD
  const goEquipes = document.getElementById("goEquipes");
  const goInscriptions = document.getElementById("goInscriptions");
  const goTirage = document.getElementById("goTirage");
  const scopeHint = document.getElementById("scopeHint");

  function applyScopePanel(s){
    goEquipes.href = `equipes.html?scope=${encodeURIComponent(s)}`;
    goInscriptions.href = `inscriptions.html?scope=${encodeURIComponent(s)}`;
    goTirage.href = `tirage.html?scope=${encodeURIComponent(s)}`;

    scopeHint.textContent = s === "dh"
      ? "Zone DM : administration du Double Messieurs."
      : "Zone DD : administration du Double Dames.";
  }

  // guard admin + affichage panels
  onAuthStateChanged(auth, async (user)=>{
    pageContent.style.display = "none";
    panelGeneral.style.display = "none";
    panelScope.style.display = "none";
    stopInfos();

    if(!user) return;
    const role = await getRoleByEmail(user.email);
    if(role !== "admin") return;

    pageContent.style.display = "block";

    const s = scope;
    if(s === "general"){
      panelGeneral.style.display = "block";
      startInfos();
    } else if(s === "dh" || s === "dd") {
      panelScope.style.display = "block";
      applyScopePanel(s);
    } else {
      panelScope.style.display = "block";
      scopeHint.textContent = "Choisis DM ou DD dans le menu â€œZoneâ€.";
    }
  });
</script>

</body>
</html>
