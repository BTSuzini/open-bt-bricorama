<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî √âquipes ‚Äî Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />

  <style>
    .table-wrap{
      overflow:auto;
      border:1px solid #eee;
      border-radius:14px;
      background:#fff;
    }
    table.teams{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }
    table.teams thead th{
      text-align:left;
      font-size:13px;
      letter-spacing:.2px;
      color:#444;
      background:#f7f7f7;
      border-bottom:1px solid #eee;
      padding:12px 12px;
      position:sticky;
      top:0;
      z-index:1;
      white-space:nowrap;
    }
    table.teams tbody td{
      padding:12px 12px;
      border-bottom:1px solid #f0f0f0;
      vertical-align:top;
      font-size:14px;
    }
    table.teams tbody tr:last-child td{ border-bottom:none; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #eee;
      background:#fafafa;
      color:#333;
      white-space:nowrap;
    }
    .pill.main{ border-color:#d9e6ff; background:#f3f7ff; font-weight:900; }
    .pill.wait{ border-color:#ffe3b3; background:#fff7e6; font-weight:900; }
    .pill.auto{ border-color:#e9e9e9; background:#fafafa; }
    .pill.stby{ border-color:#ffd37a; background:#fff7e6; font-weight:900; }

    .mini-input{
      width:86px;
      padding:10px 10px;
      border:1px solid #ddd;
      border-radius:12px;
      font-weight:900;
    }
    .mini-select{
      padding:10px 10px;
      border:1px solid #ddd;
      border-radius:12px;
      font-weight:900;
      background:#fff;
    }
    .row-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .muted2{ color:#666; font-size:13px; }
    .ok{ color:#1f7a3a; font-weight:900; }
    .bad{ color:#b00020; font-weight:900; }
  </style>
</head>

<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">üõ†Ô∏è Admin ‚Äî Gestion</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT Bricorama">
      </div>
    </div>

    <!-- ‚úÖ Bandeau identique partout : Accueil public + D√©connexion -->
    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Guard -->
  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Zone + sous-onglets (identique partout) -->
  <section class="card" id="adminZone" style="display:none;">
    <h2 style="margin:0 0 10px;">üéõÔ∏è Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">G√©n√©ral</option>
        <option value="dh">Double Hommes</option>
        <option value="dd">Double Dames</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- ‚úÖ Contenu de la rubrique (apr√®s l‚Äôencart Zone) -->
  <section class="card" id="panelTeams" style="display:none;">
    <h2 style="margin:0 0 6px;">üë• √âquipes (admin)</h2>

    <p class="muted" style="margin:0;">
      Zone : <strong id="zoneLabel">‚Äî</strong>
      ‚Äî Total : <strong><span id="totalCount">0</span></strong>
      ‚Äî Principale : <strong><span id="mainCount">0</span></strong>
      ‚Äî Attente : <strong><span id="waitCount">0</span></strong>
      ‚Äî STBY : <strong><span id="stbyCount">0</span></strong>
    </p>

    <p class="muted" id="liveStatus" style="margin-top:10px;">Connexion‚Ä¶</p>

    <div class="table-wrap" style="margin-top:12px;">
      <table class="teams" aria-label="√âquipes admin">
        <thead>
          <tr>
            <th style="width:54px;">#</th>
            <th>√âquipe</th>
            <th style="width:160px;" id="colP1">P1</th>
            <th style="width:160px;" id="colP2">P2</th>
            <th style="width:140px;">Liste</th>
            <th style="width:110px;">STBY</th>
            <th style="width:110px;">Rank P1</th>
            <th style="width:110px;">Rank P2</th>
            <th style="width:220px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted2" style="margin-top:10px;">
      ‚Ä¢ ‚ÄúListe‚Äù : <b>auto</b> = ordre d‚Äôinscription ; <b>main</b> = force liste principale ; <b>wait</b> = force attente.<br>
      ‚Ä¢ ‚ÄúRank‚Äù : chiffre (ex: 12). Sert √† l‚Äôaffichage ‚ÄúClass√©es‚Äù c√¥t√© public.
    </p>
  </section>

  <section class="card" id="panelExplain" style="display:none;">
    <h2 style="margin:0 0 8px;">‚ÑπÔ∏è S√©lectionne une zone</h2>
    <p class="muted" style="margin:0;">
      Cette page ‚Äú√âquipes‚Äù s‚Äôapplique √† <b>Double Hommes</b> ou <b>Double Dames</b>.  
      Pour ‚ÄúG√©n√©ral‚Äù, utilise l‚Äôonglet <b>Infos</b>.
    </p>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot,
    doc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // --------------------------
  // helpers
  // --------------------------
  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toNumOrNull(v){
    if(v === null || v === undefined) return null;
    const t = String(v).trim();
    if(!t) return null;
    const n = Number(t.replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  function listPill(list){
    if(list === "main") return `<span class="pill main">MAIN</span>`;
    if(list === "wait") return `<span class="pill wait">WAIT</span>`;
    return `<span class="pill auto">AUTO</span>`;
  }

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  // --------------------------
  // dom
  // --------------------------
  const accessDenied = document.getElementById("accessDenied");
  const adminZone = document.getElementById("adminZone");

  const scopeEl = document.getElementById("scope");
  const tabsEl = document.getElementById("tabs");
  const hintEl = document.getElementById("hint");

  const panelTeams = document.getElementById("panelTeams");
  const panelExplain = document.getElementById("panelExplain");

  const zoneLabel = document.getElementById("zoneLabel");
  const liveStatus = document.getElementById("liveStatus");

  const totalCountEl = document.getElementById("totalCount");
  const mainCountEl  = document.getElementById("mainCount");
  const waitCountEl  = document.getElementById("waitCount");
  const stbyCountEl  = document.getElementById("stbyCount");

  const colP1 = document.getElementById("colP1");
  const colP2 = document.getElementById("colP2");

  const tbody = document.getElementById("tbody");

  // --------------------------
  // scope / navigation
  // --------------------------
  const params = new URLSearchParams(location.search);
  const initialScope = (params.get("scope") || "general").toLowerCase();

  function setTabs(scope){
    tabsEl.innerHTML = "";
    panelTeams.style.display = "none";
    panelExplain.style.display = "none";
    tbody.innerHTML = "";

    // G√©n√©rique : liens vers pages admin, en gardant scope
    const mk = (label, href, isCurrent=false) => {
      const a = document.createElement("a");
      a.className = "btn";
      a.href = href;
      a.textContent = label;
      if(isCurrent) a.setAttribute("aria-current", "page");
      return a;
    };

    if(scope === "general"){
      hintEl.textContent = "Zone G√©n√©ral : gestion des infos (publication / modification / suppression).";
      tabsEl.appendChild(mk("üì∞ Infos", "index.html?scope=general", false));
      panelExplain.style.display = "block";
      return;
    }

    // DH / DD
    const label = (scope === "dh") ? "Double Hommes" : "Double Dames";
    hintEl.textContent = `Zone ${label} : √©quipes / inscriptions / tirage.`;
    tabsEl.appendChild(mk("üë• √âquipes", `equipes.html?scope=${encodeURIComponent(scope)}`, true));
    tabsEl.appendChild(mk("üìù Inscriptions", `inscriptions.html?scope=${encodeURIComponent(scope)}`, false));
    tabsEl.appendChild(mk("üé≤ Tirage", `tirage.html?scope=${encodeURIComponent(scope)}`, false));

    panelTeams.style.display = "block";
  }

  function setScopeSelect(scope){
    const allowed = ["general","dh","dd"];
    scopeEl.value = allowed.includes(scope) ? scope : "general";
  }

  // --------------------------
  // Firestore live
  // --------------------------
  let unsubscribe = null;
  let currentScope = "general";

  function stopLive(){
    if(unsubscribe){
      unsubscribe();
      unsubscribe = null;
    }
  }

  function startLive(scope){
    stopLive();
    tbody.innerHTML = "";
    liveStatus.textContent = "Connexion‚Ä¶";

    // collections
    const COL = (scope === "dh") ? "equipes_dh_public" : "equipes_dd_public";

    // labels colonnes
    if(scope === "dh"){
      zoneLabel.textContent = "Double Hommes";
      colP1.textContent = "Joueur 1";
      colP2.textContent = "Joueur 2";
    } else {
      zoneLabel.textContent = "Double Dames";
      colP1.textContent = "Joueuse 1";
      colP2.textContent = "Joueuse 2";
    }

    const q = query(collection(db, COL), orderBy("createdAt", "asc"));

    unsubscribe = onSnapshot(q, (snap)=>{
      const rows = [];
      snap.forEach(ds=>{
        const d = ds.data() || {};
        rows.push({
          id: ds.id,
          teamName: d.teamName || "",
          p1FirstName: d.p1FirstName || "",
          p2FirstName: d.p2FirstName || "",
          createdAtMs: d.createdAt?.toMillis ? d.createdAt.toMillis() : 0,
          list: d.list || null, // null/"" => auto
          stby: d.stby === true,
          p1Rank: d.p1Rank ?? null,
          p2Rank: d.p2Rank ?? null
        });
      });

      // counts (main/wait auto: on compte seulement les "forc√©s" ici, la r√©partition auto se fait c√¥t√© public)
      const mainForced = rows.filter(r=> r.list === "main").length;
      const waitForced = rows.filter(r=> r.list === "wait").length;
      const stby = rows.filter(r=> r.stby).length;

      totalCountEl.textContent = rows.length;
      mainCountEl.textContent  = mainForced;
      waitCountEl.textContent  = waitForced;
      stbyCountEl.textContent  = stby;

      renderTable(rows, COL);
      liveStatus.textContent = "üü¢ En direct";
    }, (err)=>{
      console.error(err);
      liveStatus.textContent = "üî¥ Erreur de connexion";
    });
  }

  function renderTable(rows, COL){
    if(rows.length === 0){
      tbody.innerHTML = `<tr><td colspan="9" class="muted" style="padding:14px;">Aucune √©quipe.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map((r, idx)=>{
      const listValue = (r.list === "main" || r.list === "wait") ? r.list : "auto";
      const stbyChecked = r.stby ? "checked" : "";
      const p1v = (r.p1Rank ?? "") === null ? "" : String(r.p1Rank ?? "");
      const p2v = (r.p2Rank ?? "") === null ? "" : String(r.p2Rank ?? "");

      return `
        <tr data-id="${esc(r.id)}">
          <td class="muted2">#${idx+1}</td>
          <td><div style="font-weight:900;">${esc(r.teamName)}</div><div class="muted2">${listPill(r.list)}</div></td>
          <td><span class="pill">${esc(r.p1FirstName)}</span></td>
          <td><span class="pill">${esc(r.p2FirstName)}</span></td>

          <td>
            <select class="mini-select" data-field="list">
              <option value="auto" ${listValue==="auto"?"selected":""}>auto</option>
              <option value="main" ${listValue==="main"?"selected":""}>main</option>
              <option value="wait" ${listValue==="wait"?"selected":""}>wait</option>
            </select>
          </td>

          <td>
            <label style="display:flex; align-items:center; gap:10px;">
              <input type="checkbox" data-field="stby" ${stbyChecked} />
              <span class="pill stby">STBY</span>
            </label>
          </td>

          <td><input class="mini-input" data-field="p1Rank" inputmode="numeric" placeholder="‚Äî" value="${esc(p1v)}"></td>
          <td><input class="mini-input" data-field="p2Rank" inputmode="numeric" placeholder="‚Äî" value="${esc(p2v)}"></td>

          <td>
            <div class="row-actions">
              <button class="btn" data-action="save" style="font-weight:900; color:#111;">üíæ Enregistrer</button>
              <button class="btn" data-action="delete" style="font-weight:900; color:#111; border-color:#f1b2b2;">üóëÔ∏è Supprimer</button>
            </div>
            <div class="muted2" data-status style="margin-top:8px;"></div>
          </td>
        </tr>
      `;
    }).join("");

    // events
    tbody.querySelectorAll("tr[data-id]").forEach(tr=>{
      const id = tr.getAttribute("data-id");
      const status = tr.querySelector("[data-status]");

      const getVal = (field)=>{
        if(field === "list"){
          const v = tr.querySelector('select[data-field="list"]').value;
          return v;
        }
        if(field === "stby"){
          return tr.querySelector('input[type="checkbox"][data-field="stby"]').checked;
        }
        if(field === "p1Rank"){
          return tr.querySelector('input[data-field="p1Rank"]').value;
        }
        if(field === "p2Rank"){
          return tr.querySelector('input[data-field="p2Rank"]').value;
        }
        return null;
      };

      tr.querySelector('button[data-action="save"]').onclick = async ()=>{
        status.textContent = "Enregistrement‚Ä¶";
        try{
          const listRaw = getVal("list");
          const stby = !!getVal("stby");
          const p1Rank = toNumOrNull(getVal("p1Rank"));
          const p2Rank = toNumOrNull(getVal("p2Rank"));

          const payload = {
            stby,
            p1Rank: p1Rank === null ? null : p1Rank,
            p2Rank: p2Rank === null ? null : p2Rank,
          };

          // list: auto => on supprime le champ
          if(listRaw === "auto") payload.list = null;
          else payload.list = listRaw;

          // nettoyage: null => deleteField ? ici on met null (ok) et c√¥t√© public on traite null comme auto
          await updateDoc(doc(db, COL, id), payload);

          status.innerHTML = `<span class="ok">‚úÖ OK</span>`;
        }catch(e){
          console.error(e);
          status.innerHTML = `<span class="bad">‚ùå Erreur</span>`;
        }
      };

      tr.querySelector('button[data-action="delete"]').onclick = async ()=>{
        const ok = confirm("Supprimer cette √©quipe ?\n\n‚ö†Ô∏è Action irr√©versible.");
        if(!ok) return;
        status.textContent = "Suppression‚Ä¶";
        try{
          await deleteDoc(doc(db, COL, id));
          status.innerHTML = `<span class="ok">‚úÖ Supprim√©e</span>`;
        }catch(e){
          console.error(e);
          status.innerHTML = `<span class="bad">‚ùå Erreur</span>`;
        }
      };
    });
  }

  // --------------------------
  // logout
  // --------------------------
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // --------------------------
  // guard + init
  // --------------------------
  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminZone.style.display = "none";
    panelTeams.style.display = "none";
    panelExplain.style.display = "none";
    stopLive();

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    adminZone.style.display = "block";

    setScopeSelect(initialScope);
    currentScope = scopeEl.value;
    setTabs(currentScope);

    if(currentScope === "dh" || currentScope === "dd"){
      startLive(currentScope);
    }

    scopeEl.onchange = ()=>{
      currentScope = scopeEl.value;

      // update URL (sans reload dur)
      const u = new URL(location.href);
      u.searchParams.set("scope", currentScope);
      history.replaceState({}, "", u.toString());

      setTabs(currentScope);

      if(currentScope === "dh" || currentScope === "dd") startLive(currentScope);
      else stopLive();
    };
  });
</script>

</body>
</html>
