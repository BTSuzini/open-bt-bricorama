<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî √âquipes ‚Äî Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">üõ†Ô∏è Admin ‚Äî Gestion</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT Bricorama">
      </div>
    </div>

    <!-- ‚úÖ Bandeau identique partout -->
    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Encart Zone identique partout -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üéõÔ∏è Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">G√©n√©ral</option>
        <option value="dh" selected>DM</option>
        <option value="dd">DD</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- =========================
       CONTENU √âQUIPES (apr√®s Zone)
  ========================== -->
  <section class="card" id="panelEquipes" style="display:none;">
    <h2 style="margin:0 0 10px;">üë• √âquipes (admin) ‚Äî <span id="zoneLabel">DM</span></h2>

    <p class="muted" style="margin-top:0;">
      Ici tu peux :
      <b>forcer la liste</b> (main/attente),
      <b>mettre STBY</b>,
      <b>renseigner les classements</b> (p1Rank/p2Rank).
    </p>

    <p class="muted" id="counts" style="margin:0;">Chargement‚Ä¶</p>
    <p class="muted" id="liveStatus" style="margin-top:6px;">Connexion‚Ä¶</p>

    <div class="table-wrap" style="margin-top:12px;">
      <table class="teams-table" aria-label="√âquipes admin">
        <thead>
          <tr>
            <th style="width:44px;">#</th>
            <th>√âquipe</th>
            <th style="width:170px;">Joueur/Joueuse 1</th>
            <th style="width:170px;">Joueur/Joueuse 2</th>
            <th style="width:120px;">Liste</th>
            <th style="width:110px;">STBY</th>
            <th style="width:160px;">Classements</th>
            <th style="width:220px;">Actions</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:10px;">
      Astuce : si tu ne forces pas ‚Äúlist‚Äù, l‚Äôordre public est bas√© sur l‚Äôordre d‚Äôinscription (createdAt).
    </p>
  </section>

</main>

<style>
  .table-wrap{
    overflow:auto;
    border:1px solid #eee;
    border-radius:14px;
    background:#fff;
  }
  .teams-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width: 980px;
  }
  .teams-table thead th{
    text-align:left;
    font-size:13px;
    letter-spacing:.2px;
    color:#444;
    background:#f7f7f7;
    border-bottom:1px solid #eee;
    padding:12px 12px;
    position:sticky;
    top:0;
    z-index:1;
  }
  .teams-table tbody td{
    padding:12px 12px;
    border-bottom:1px solid #f0f0f0;
    vertical-align:top;
    font-size:14px;
  }
  .teams-table tbody tr:last-child td{ border-bottom:none; }

  .pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #eee;
    background:#fafafa;
    color:#333;
    white-space:nowrap;
  }
  .pill.main{ border-color:#d9f2df; background:#f3fff6; font-weight:900; }
  .pill.wait{ border-color:#ffe1a6; background:#fff8e6; font-weight:900; }
  .pill.stby{ border-color:#ffd37a; background:#fff7e6; font-weight:900; }

  .btn.small{
    padding:8px 10px;
    border-radius:12px;
    font-weight:900;
    color:#111;
  }

  .mono{
    font-variant-numeric: tabular-nums;
    white-space:nowrap;
  }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection,
    query,
    orderBy,
    onSnapshot,
    doc,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // -----------------------------
  // Scope handling
  // -----------------------------
  const params = new URLSearchParams(location.search);
  const scopeParam = (params.get("scope") || "dh").toLowerCase();

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const panelEquipes = document.getElementById("panelEquipes");
  const zoneLabel = document.getElementById("zoneLabel");
  const countsEl = document.getElementById("counts");
  const liveStatusEl = document.getElementById("liveStatus");
  const bodyEl = document.getElementById("body");

  let unsubscribe = null;

  function setScopeSelect(value){
    // map : dh->DM, dd->DD, general->G√©n√©ral
    scopeEl.value = (value === "dd" || value === "general") ? value : "dh";
  }

  function zoneText(sc){
    if(sc === "dd") return "DD";
    if(sc === "general") return "G√©n√©ral";
    return "DM";
  }

  function stopLive(){
    if(unsubscribe){
      unsubscribe();
      unsubscribe = null;
    }
  }

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toNum(v){
    if(v === null || v === undefined || v === "") return null;
    const n = typeof v === "number" ? v : Number(String(v).replace(",", ".").trim());
    return Number.isFinite(n) ? n : null;
  }

  function pillList(list){
    if(list === "main") return `<span class="pill main">MAIN</span>`;
    if(list === "wait") return `<span class="pill wait">ATT</span>`;
    return `<span class="pill">AUTO</span>`;
  }

  function pillStby(stby){
    return stby ? `<span class="pill stby">STBY</span>` : `<span class="pill">OK</span>`;
  }

  function computeCounts(rows){
    const main = rows.filter(r => r.list === "main").length;
    const wait = rows.filter(r => r.list === "wait").length;
    const auto = rows.filter(r => !r.list).length;
    const stby = rows.filter(r => r.stby).length;
    return { total: rows.length, main, wait, auto, stby };
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";
    hintEl.textContent = "";

    const make = (label, href, isCurrent=false) => {
      const a = document.createElement("a");
      a.className = "btn";
      a.href = href;
      a.textContent = label;
      if(isCurrent) a.setAttribute("aria-current", "page");
      tabsEl.appendChild(a);
    };

    if(scope === "general"){
      hintEl.textContent = "Zone G√©n√©ral : publication des infos (via admin/index).";
      make("üì∞ Infos", "index.html?scope=general", false);
      make("üë• √âquipes", "equipes.html?scope=dh", true); // on garde la page, mais √ßa pousse vers DH
      make("üìù Inscriptions", "inscriptions.html?scope=dh", false);
      make("üé≤ Tirage", "tirage.html?scope=dh", false);
      return;
    }

    hintEl.textContent = `Zone ${zoneText(scope)} : gestion √©quipes / inscriptions / tirage.`;

    make("üë• √âquipes", `equipes.html?scope=${encodeURIComponent(scope)}`, true);
    make("üìù Inscriptions", `inscriptions.html?scope=${encodeURIComponent(scope)}`, false);
    make("üé≤ Tirage", `tirage.html?scope=${encodeURIComponent(scope)}`, false);
    make("üì∞ Infos", "index.html?scope=general", false);
  }

  function startLive(scope){
    stopLive();
    bodyEl.innerHTML = "";
    countsEl.textContent = "Chargement‚Ä¶";
    liveStatusEl.textContent = "Connexion‚Ä¶";

    if(scope === "general"){
      panelEquipes.style.display = "none";
      return;
    }

    panelEquipes.style.display = "block";
    zoneLabel.textContent = zoneText(scope);

    const colName = (scope === "dd") ? "equipes_dd_public" : "equipes_dh_public";
    const q = query(collection(db, colName), orderBy("createdAt", "asc"));

    unsubscribe = onSnapshot(q, (snap)=>{
      const rows = snap.docs.map(d => {
        const x = d.data() || {};
        return {
          id: d.id,
          teamName: x.teamName || "",
          p1FirstName: x.p1FirstName || "",
          p2FirstName: x.p2FirstName || "",
          list: x.list || null,
          stby: x.stby === true,
          p1Rank: x.p1Rank ?? null,
          p2Rank: x.p2Rank ?? null,
          createdAtMs: x.createdAt?.toMillis ? x.createdAt.toMillis() : 0
        };
      });

      const c = computeCounts(rows);
      countsEl.innerHTML =
        `Total : <b>${c.total}</b> ‚Äî MAIN : <b>${c.main}</b> ‚Äî ATT : <b>${c.wait}</b> ‚Äî AUTO : <b>${c.auto}</b> ‚Äî STBY : <b>${c.stby}</b>`;

      bodyEl.innerHTML = rows.length ? rows.map((r, i) => {
        const p1 = toNum(r.p1Rank);
        const p2 = toNum(r.p2Rank);
        const teamRank = (p1 !== null && p2 !== null) ? (p1 + p2) : null;

        return `
          <tr>
            <td class="mono">#${i+1}</td>

            <td>
              <div style="font-weight:900;">${esc(r.teamName)}</div>
              <div class="muted" style="margin-top:6px;">ID: <span class="mono">${esc(r.id)}</span></div>
            </td>

            <td><span class="pill">${esc(r.p1FirstName)}</span></td>
            <td><span class="pill">${esc(r.p2FirstName)}</span></td>

            <td>${pillList(r.list)}</td>
            <td>${pillStby(r.stby)}</td>

            <td>
              <div class="muted" style="margin:0;">
                p1: <b>${p1 ?? "‚Äî"}</b> ‚Ä¢ p2: <b>${p2 ?? "‚Äî"}</b>
              </div>
              <div class="muted" style="margin-top:6px;">
                √©quipe: <b>${teamRank ?? "‚Äî"}</b>
              </div>
            </td>

            <td>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn small" data-main="${esc(r.id)}">MAIN</button>
                <button class="btn small" data-wait="${esc(r.id)}">ATT</button>
                <button class="btn small" data-auto="${esc(r.id)}">AUTO</button>
                <button class="btn small" data-stby="${esc(r.id)}">${r.stby ? "STBY ‚úñ" : "STBY ‚úì"}</button>
                <button class="btn small" data-rank="${esc(r.id)}">üè∑Ô∏è Ranks</button>
                <button class="btn small" data-del="${esc(r.id)}" style="border-color:#f1b2b2;">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join("") : `
        <tr>
          <td colspan="8" class="muted" style="padding:14px;">Aucune √©quipe.</td>
        </tr>
      `;

      // Actions
      const refFor = (id) => doc(db, colName, id);

      bodyEl.querySelectorAll("button[data-main]").forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.main;
          await updateDoc(refFor(id), { list: "main" });
        };
      });

      bodyEl.querySelectorAll("button[data-wait]").forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.wait;
          await updateDoc(refFor(id), { list: "wait" });
        };
      });

      bodyEl.querySelectorAll("button[data-auto]").forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.auto;
          await updateDoc(refFor(id), { list: null });
        };
      });

      bodyEl.querySelectorAll("button[data-stby]").forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.stby;
          // toggle: on relit via dataset? plus simple: prompt
          // => on fait un toggle optimiste en lisant le texte du bouton
          const goingOn = b.textContent.includes("‚úì");
          await updateDoc(refFor(id), { stby: goingOn });
        };
      });

      bodyEl.querySelectorAll("button[data-rank]").forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.rank;
          const row = rows.find(x => x.id === id);
          if(!row) return;

          const cur1 = (row.p1Rank ?? "");
          const cur2 = (row.p2Rank ?? "");

          const n1 = prompt("Classement BT Joueur/Joueuse 1 (nombre) :", String(cur1));
          if(n1 === null) return;

          const n2 = prompt("Classement BT Joueur/Joueuse 2 (nombre) :", String(cur2));
          if(n2 === null) return;

          const p1 = (String(n1).trim() === "") ? null : Number(String(n1).replace(",", ".").trim());
          const p2 = (String(n2).trim() === "") ? null : Number(String(n2).replace(",", ".").trim());

          if(p1 !== null && !Number.isFinite(p1)) return alert("p1Rank invalide.");
          if(p2 !== null && !Number.isFinite(p2)) return alert("p2Rank invalide.");

          await updateDoc(refFor(id), { p1Rank: p1, p2Rank: p2 });
        };
      });

      bodyEl.querySelectorAll("button[data-del]").forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.del;
          const ok = confirm("Supprimer cette √©quipe ?\n\n‚ö†Ô∏è Action irr√©versible.");
          if(!ok) return;
          await deleteDoc(refFor(id));
        };
      });

      liveStatusEl.textContent = "üü¢ En direct";
    }, (err)=>{
      console.error(err);
      liveStatusEl.textContent = "üî¥ Erreur de connexion";
      countsEl.textContent = "‚ùå Impossible de charger les √©quipes.";
    });
  }

  // -----------------------------
  // Logout
  // -----------------------------
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // -----------------------------
  // Guard admin + init
  // -----------------------------
  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminUI.style.display = "none";
    panelEquipes.style.display = "none";
    stopLive();

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    adminUI.style.display = "block";

    // apply scope from URL (default dh)
    const sc = (scopeParam === "dd" || scopeParam === "general") ? scopeParam : "dh";
    setScopeSelect(sc);
    setTabs(sc);
    startLive(sc);

    // change scope => navigate (garde des pages s√©par√©es)
    scopeEl.onchange = ()=>{
      const next = scopeEl.value;
      // on garde la logique multi-pages : on recharge la page avec le scope
      window.location.href = `equipes.html?scope=${encodeURIComponent(next)}`;
    };
  });
</script>

</body>
</html>
