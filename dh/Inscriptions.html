<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inscriptions ‚Äî Double Hommes</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        Open BT Bricorama<br>
        <span style="opacity:.95;font-weight:800;">Double Hommes</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="programmation.html">Programmation</a>
      <a href="equipes.html">√âquipes</a>
      <a href="inscriptions.html" aria-current="page">Inscriptions</a>
      <a href="../pages/infos.html">Infos</a>
      <a href="../pages/reglement.html">R√®glement</a>
    </nav>
  </div>
</header>

<main class="container">

<section class="card">
  <h2>Formulaire d‚Äôinscription ‚Äî Double Hommes</h2>

  <p id="gateMsg" class="muted">Chargement‚Ä¶</p>

  <form id="signupForm" class="form" autocomplete="on">

    <div class="field">
      <label for="teamName">Nom de l‚Äô√©quipe *</label>
      <input id="teamName" name="teamName" type="text" required maxlength="40">
    </div>

    <hr class="sep" />

    <h3>Joueur 1 üë®</h3>

    <div class="field">
      <label for="p1LastName">Nom *</label>
      <input id="p1LastName" required>
    </div>

    <div class="field">
      <label for="p1FirstName">Pr√©nom *</label>
      <input id="p1FirstName" required>
    </div>

    <div class="field">
      <label for="p1Licence">N¬∞ Licence *</label>
      <input id="p1Licence" required>
    </div>

    <div class="field">
      <label for="p1Phone">T√©l√©phone *</label>
      <input id="p1Phone" type="tel" required>
    </div>

    <hr class="sep" />

    <h3>Joueur 2 üë®</h3>

    <div class="field">
      <label for="p2LastName">Nom *</label>
      <input id="p2LastName" required>
    </div>

    <div class="field">
      <label for="p2FirstName">Pr√©nom *</label>
      <input id="p2FirstName" required>
    </div>

    <div class="field">
      <label for="p2Licence">N¬∞ Licence *</label>
      <input id="p2Licence" required>
    </div>

    <div class="field">
      <label for="p2Phone">T√©l√©phone *</label>
      <input id="p2Phone" type="tel" required>
    </div>

    <hr class="sep" />

    <button id="submitBtn" class="btn" type="submit" style="font-weight:800;">
      ‚úÖ Valider
    </button>

    <p id="status" class="muted"></p>

  </form>
</section>

</main>

<script type="module">
import { db } from "../assets/js/firebase.js";
import {
  doc,
  onSnapshot,
  collection,
  addDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const COL_PRIVATE = "inscriptions_dh_private";
const COL_PUBLIC  = "equipes_dh_public";

const form = document.getElementById("signupForm");
const statusEl = document.getElementById("status");
const gateMsgEl = document.getElementById("gateMsg");
const submitBtn = document.getElementById("submitBtn");

let gateState = "not_open";

function applyGate(state){
  gateState = state || "not_open";

  if(gateState === "open"){
    gateMsgEl.textContent = "‚úÖ Inscriptions ouvertes.";
    submitBtn.disabled = false;
  } else if(gateState === "paused"){
    gateMsgEl.textContent = "‚è∏Ô∏è Inscriptions suspendues.";
    submitBtn.disabled = true;
  } else if(gateState === "closed"){
    gateMsgEl.textContent = "üîí Inscriptions cl√¥tur√©es.";
    submitBtn.disabled = true;
  } else {
    gateMsgEl.textContent = "‚è≥ Pas encore ouvertes.";
    submitBtn.disabled = true;
  }
}

const cfgRef = doc(db, "config", "dh");
onSnapshot(cfgRef, snap=>{
  applyGate(snap.exists() ? snap.data().inscriptionsState : "not_open");
});

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(gateState !== "open"){
    statusEl.textContent = "‚õî Inscriptions ferm√©es.";
    return;
  }

  submitBtn.disabled = true;
  statusEl.textContent = "Envoi‚Ä¶";

  try{
    const data = {
      createdAt: serverTimestamp(),
      teamName: teamName.value.trim(),
      p1FirstName: p1FirstName.value.trim(),
      p1LastName: p1LastName.value.trim(),
      p1Licence: p1Licence.value.trim(),
      p1Phone: p1Phone.value.trim(),
      p2FirstName: p2FirstName.value.trim(),
      p2LastName: p2LastName.value.trim(),
      p2Licence: p2Licence.value.trim(),
      p2Phone: p2Phone.value.trim(),
    };

    const ref = await addDoc(collection(db, COL_PRIVATE), data);

    await setDoc(doc(db, COL_PUBLIC, ref.id), {
      createdAt: serverTimestamp(),
      teamName: data.teamName,
      p1FirstName: data.p1FirstName,
      p2FirstName: data.p2FirstName,
      list: "main",
      stby: false
    });

    form.reset();
    statusEl.textContent = "‚úÖ Inscription enregistr√©e !";

  }catch(err){
    console.error(err);
    statusEl.textContent = "‚ùå Erreur.";
  }finally{
    submitBtn.disabled = false;
  }
});
</script>

</body>
</html>
