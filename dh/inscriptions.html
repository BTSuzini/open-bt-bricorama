<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inscriptions â€” Double Hommes â€” Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        Open BT Bricorama<br>
        <span style="opacity:.95;font-weight:800;">Double Hommes</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="programmation.html">Programmation</a>
      <a href="equipes.html">Ã‰quipes</a>
      <a href="inscriptions.html" aria-current="page">Inscriptions</a>
      <a href="tirage.html">Tirage</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="cardForm">
    <h2>ğŸ“ Formulaire dâ€™inscription â€” Double Hommes</h2>
    <p id="gateMsg" class="muted">Chargementâ€¦</p>

    <form id="signupForm" class="form">

      <div class="field">
        <label>Nom de lâ€™Ã©quipe *</label>
        <input id="teamName" required maxlength="40">
      </div>

      <hr class="sep" />

      <h3>Joueur 1 ğŸ‘¨</h3>
      <div class="field"><label>Nom *</label><input id="p1LastName" required></div>
      <div class="field"><label>PrÃ©nom *</label><input id="p1FirstName" required></div>
      <div class="field"><label>NÂ° Licence *</label><input id="p1Licence" required></div>
      <div class="field"><label>TÃ©lÃ©phone *</label><input id="p1Phone" required></div>

      <hr class="sep" />

      <h3>Joueur 2 ğŸ‘¨</h3>
      <div class="field"><label>Nom *</label><input id="p2LastName" required></div>
      <div class="field"><label>PrÃ©nom *</label><input id="p2FirstName" required></div>
      <div class="field"><label>NÂ° Licence *</label><input id="p2Licence" required></div>
      <div class="field"><label>TÃ©lÃ©phone *</label><input id="p2Phone" required></div>

      <hr class="sep" />

      <button id="submitBtn" class="btn" type="submit" style="font-weight:900;">âœ… Valider</button>
      <p id="status" class="muted"></p>
    </form>
  </section>

  <section class="card" id="cardSuccess" style="display:none;">
    <h2>âœ… Inscription enregistrÃ©e</h2>
    <p class="muted">Merci pour votre inscription ğŸ™Œ</p>
    <div class="grid" style="margin-top:12px;">
      <a class="btn" href="equipes.html">ğŸ‘¥ Voir les Ã©quipes</a>
      <a class="btn" href="programmation.html">ğŸ“… Programmation</a>
    </div>
  </section>

</main>

<script type="module">
import { db } from "../assets/js/firebase.js";
import {
  doc, onSnapshot,
  collection, addDoc, setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const COL_PRIVATE = "inscriptions_dh_private";
const COL_PUBLIC  = "equipes_dh_public";
const CFG_FIELD   = "inscriptionsDHState";

const cardForm = document.getElementById("cardForm");
const cardSuccess = document.getElementById("cardSuccess");
const form = document.getElementById("signupForm");
const submitBtn = document.getElementById("submitBtn");
const statusEl = document.getElementById("status");
const gateMsgEl = document.getElementById("gateMsg");

let gateState = "not_open";
let isSubmitting = false;

function showSuccess(){
  cardForm.style.display = "none";
  cardSuccess.style.display = "block";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function normalizeState(s){
  if(s === "suspended") return "paused";
  return s || "not_open";
}

function applyGate(state){
  gateState = normalizeState(state);
  if(gateState === "open"){
    gateMsgEl.textContent = "âœ… Inscriptions ouvertes.";
    submitBtn.disabled = false;
  } else {
    submitBtn.disabled = true;
    gateMsgEl.textContent =
      gateState === "closed" ? "ğŸ”’ Inscriptions clÃ´turÃ©es."
      : gateState === "paused" ? "â¸ï¸ Inscriptions suspendues."
      : "â³ Pas encore ouvertes.";
  }
}

onSnapshot(doc(db,"config","open"), snap=>{
  const data = snap.data() || {};
  applyGate(data[CFG_FIELD]);
});

form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(isSubmitting || gateState !== "open") return;

  isSubmitting = true;
  submitBtn.disabled = true;
  statusEl.textContent = "Envoi en coursâ€¦";

  try{
    const data = {
      createdAt: serverTimestamp(),
      teamName: teamName.value.trim(),
      p1FirstName: p1FirstName.value.trim(),
      p1LastName: p1LastName.value.trim(),
      p1Licence: p1Licence.value.trim(),
      p1Phone: p1Phone.value.trim(),
      p2FirstName: p2FirstName.value.trim(),
      p2LastName: p2LastName.value.trim(),
      p2Licence: p2Licence.value.trim(),
      p2Phone: p2Phone.value.trim()
    };

    const ref = await addDoc(collection(db,COL_PRIVATE), data);

    await setDoc(doc(db,COL_PUBLIC,ref.id),{
      createdAt: serverTimestamp(),
      teamName: data.teamName,
      p1FirstName: data.p1FirstName,
      p2FirstName: data.p2FirstName,
      list: "main",
      stby: false
    });

    form.reset();

    const recap =
      `âœ… Inscription enregistrÃ©e !\n\n` +
      `Ã‰quipe : ${data.teamName}\n` +
      `Joueurs : ${data.p1FirstName} ${data.p1LastName} & ${data.p2FirstName} ${data.p2LastName}`;

    alert(recap);
    showSuccess();

  }catch(err){
    console.error(err);
    statusEl.textContent = "âŒ Erreur lors de lâ€™enregistrement.";
    submitBtn.disabled = false;
  }finally{
    isSubmitting = false;
  }
});
</script>

</body>
</html>
