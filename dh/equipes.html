<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√âquipes ‚Äî Double Hommes ‚Äî Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">Open BT Bricorama<br><span style="opacity:.95;font-weight:800;">Double Hommes</span></h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT Bricorama">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="programmation.html">Programmation</a>
      <a href="equipes.html" aria-current="page">√âquipes</a>
      <a href="inscriptions.html">Inscriptions</a>
      <a href="tirage.html">Tirage</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Compteurs + sous-onglets -->
  <section class="card">
    <h2 style="margin-bottom:6px;">üë• √âquipes inscrites</h2>

    <p class="muted" style="margin-top:0;">
      Total : <strong><span id="totalCount">0</span></strong>
      ‚Äî Principale : <strong><span id="mainCount">0</span></strong>/10
      ‚Äî Attente : <strong><span id="waitCount">0</span></strong>
      ‚Äî STBY : <strong><span id="stbyCount">0</span></strong>
    </p>

    <div class="subtabs" role="tablist" aria-label="Affichage √©quipes">
      <button class="subtab" id="tabInscrits" type="button" role="tab" aria-selected="true" aria-controls="panelInscrits">
        ‚úÖ Inscrits
      </button>
      <button class="subtab" id="tabClassees" type="button" role="tab" aria-selected="false" aria-controls="panelClassees">
        üè∑Ô∏è Class√©es
      </button>
    </div>

    <p class="muted" id="status" style="margin-top:10px;">Connexion‚Ä¶</p>
  </section>

  <!-- =========================
       VUE 1 : INSCRITS
  ========================== -->
  <div id="panelInscrits" role="tabpanel" aria-labelledby="tabInscrits">

    <!-- Liste principale -->
    <section class="card">
      <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <span>‚úÖ Liste principale</span>
        <span class="muted" style="font-weight:700;"><span id="mainCount2">0</span>/10</span>
      </h2>

      <div class="table-wrap">
        <table class="teams-table" aria-label="Liste principale">
          <thead>
            <tr>
              <th style="width:44px;">#</th>
              <th>√âquipe</th>
              <th>Joueur 1</th>
              <th>Joueur 2</th>
              <th style="width:90px;">Statut</th>
            </tr>
          </thead>
          <tbody id="mainBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Liste d'attente -->
    <section class="card">
      <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <span>‚è≥ Liste d‚Äôattente</span>
        <span class="muted" style="font-weight:700;"><span id="waitCount2">0</span></span>
      </h2>

      <div class="table-wrap">
        <table class="teams-table" aria-label="Liste d‚Äôattente">
          <thead>
            <tr>
              <th style="width:44px;">#</th>
              <th>√âquipe</th>
              <th>Joueur 1</th>
              <th>Joueur 2</th>
              <th style="width:90px;">Statut</th>
            </tr>
          </thead>
          <tbody id="waitBody"></tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- =========================
       VUE 2 : CLASS√âES
       - seulement liste principale
       - tri par (p1Rank+p2Rank) croissant
  ========================== -->
  <div id="panelClassees" style="display:none;" role="tabpanel" aria-labelledby="tabClassees">

    <section class="card">
      <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <span>üè∑Ô∏è √âquipes class√©es (liste principale)</span>
        <span class="muted" style="font-weight:700;"><span id="rankedCount">0</span> √©quipe(s)</span>
      </h2>

      <p class="muted" style="margin-top:0;">
        Tri : <b>classement √©quipe croissant</b> (Joueur 1 + Joueur 2). Le plus petit est en haut.
      </p>

      <div class="table-wrap">
        <table class="teams-table" aria-label="√âquipes class√©es">
          <thead>
            <tr>
              <th style="width:44px;">#</th>
              <th>√âquipe</th>
              <th>Joueur 1</th>
              <th>Joueur 2</th>
              <th style="width:90px;">Statut</th>
            </tr>
          </thead>
          <tbody id="rankedBody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        ‚ö†Ô∏è Si le classement d‚Äôun joueur n‚Äôest pas encore renseign√© par l‚Äôadmin, l‚Äô√©quipe appara√Æt en bas avec ‚Äú‚Äî‚Äù.
      </p>
    </section>

  </div>

</main>

<style>
  .table-wrap{
    overflow:auto;
    border:1px solid #eee;
    border-radius:14px;
    background:#fff;
  }
  .teams-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width: 620px;
  }
  .teams-table thead th{
    text-align:left;
    font-size:13px;
    letter-spacing:.2px;
    color:#444;
    background:#f7f7f7;
    border-bottom:1px solid #eee;
    padding:12px 12px;
    position:sticky;
    top:0;
    z-index:1;
  }
  .teams-table tbody td{
    padding:12px 12px;
    border-bottom:1px solid #f0f0f0;
    vertical-align:top;
    font-size:14px;
  }
  .teams-table tbody tr:last-child td{ border-bottom:none; }

  .pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #eee;
    background:#fafafa;
    color:#333;
    white-space:nowrap;
  }
  .pill.stby{
    border-color:#ffd37a;
    background:#fff7e6;
  }
  .pill.rank{
    border-color:#d9e6ff;
    background:#f3f7ff;
    font-weight:800;
  }

  .num{
    color:#666;
    font-variant-numeric: tabular-nums;
    white-space:nowrap;
  }
  .team{ font-weight:800; }

  .subtabs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .subtab{
    appearance:none;
    border:1px solid #ddd;
    background:#fafafa;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
  }
  .subtab[aria-selected="true"]{
    background:#fff;
    border-color:#cfcfcf;
    box-shadow: 0 6px 14px rgba(0,0,0,.06);
  }

  @media (max-width: 520px){
    .teams-table{ min-width: 600px; }
  }
</style>

<script type="module">
  import { db } from "../assets/js/firebase.js";
  import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const MAX_MAIN = 10;
  const COL_PUBLIC = "equipes_dh_public";
  const LS_KEY = "openbt_dh_equipes_view";

  const statusEl = document.getElementById("status");

  const totalCountEl = document.getElementById("totalCount");
  const mainCountEl = document.getElementById("mainCount");
  const waitCountEl = document.getElementById("waitCount");
  const stbyCountEl = document.getElementById("stbyCount");

  const mainCount2El = document.getElementById("mainCount2");
  const waitCount2El = document.getElementById("waitCount2");

  const rankedCountEl = document.getElementById("rankedCount");

  const mainBody = document.getElementById("mainBody");
  const waitBody = document.getElementById("waitBody");
  const rankedBody = document.getElementById("rankedBody");

  const tabInscrits = document.getElementById("tabInscrits");
  const tabClassees = document.getElementById("tabClassees");
  const panelInscrits = document.getElementById("panelInscrits");
  const panelClassees = document.getElementById("panelClassees");

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function toNum(v){
    if(v === null || v === undefined || v === "") return null;
    const n = typeof v === "number" ? v : Number(String(v).replace(",", ".").trim());
    return Number.isFinite(n) ? n : null;
  }

  function fmtRank(n){
    return (n === null || n === undefined) ? "‚Äî" : String(n);
  }

  function statusPill(r){
    return r.stby ? `<span class="pill stby">STBY</span>` : `<span class="pill">OK</span>`;
  }

  function rowHtml(idx, r){
    return `
      <tr>
        <td class="num">#${idx}</td>
        <td class="team">${esc(r.teamName)}</td>
        <td><span class="pill">${esc(r.p1FirstName)}</span></td>
        <td><span class="pill">${esc(r.p2FirstName)}</span></td>
        <td>${statusPill(r)}</td>
      </tr>
    `;
  }

  function rowRankedHtml(idx, r){
    const p1 = toNum(r.p1Rank);
    const p2 = toNum(r.p2Rank);
    const teamRank = (p1 !== null && p2 !== null) ? (p1 + p2) : null;

    return `
      <tr>
        <td class="num">#${idx}</td>
        <td class="team">
          ${esc(r.teamName)}
          <div style="margin-top:6px;">
            <span class="pill rank">üè∑Ô∏è √âquipe : ${esc(fmtRank(teamRank))}</span>
          </div>
        </td>
        <td>
          <span class="pill">${esc(r.p1FirstName)}</span>
          <div style="margin-top:6px;">
            <span class="pill rank">BT : ${esc(fmtRank(p1))}</span>
          </div>
        </td>
        <td>
          <span class="pill">${esc(r.p2FirstName)}</span>
          <div style="margin-top:6px;">
            <span class="pill rank">BT : ${esc(fmtRank(p2))}</span>
          </div>
        </td>
        <td>${statusPill(r)}</td>
      </tr>
    `;
  }

  function computeLists(rows){
    rows.sort((a,b) => (a.createdAtMs||0) - (b.createdAtMs||0));

    const forcedMain = rows.filter(r => r.list === "main");
    const forcedWait = rows.filter(r => r.list === "wait");
    const auto = rows.filter(r => !r.list);

    const main = [];
    const used = new Set();

    for(const r of forcedMain){
      if(!used.has(r.id)){ main.push(r); used.add(r.id); }
    }
    for(const r of auto){
      if(main.length >= MAX_MAIN) break;
      if(!used.has(r.id)){ main.push(r); used.add(r.id); }
    }

    const wait = [];
    for(const r of forcedWait){
      if(!used.has(r.id)){ wait.push(r); used.add(r.id); }
    }
    for(const r of rows){
      if(!used.has(r.id)){ wait.push(r); used.add(r.id); }
    }

    return { main, wait };
  }

  function render(rows){
    const { main, wait } = computeLists(rows);

    totalCountEl.textContent = rows.length;
    mainCountEl.textContent = main.length;
    waitCountEl.textContent = wait.length;
    stbyCountEl.textContent = rows.filter(r => r.stby).length;

    mainCount2El.textContent = main.length;
    waitCount2El.textContent = wait.length;

    mainBody.innerHTML = main.length
      ? main.map((r,i) => rowHtml(i+1, r)).join("")
      : `<tr><td colspan="5" class="muted" style="padding:14px;">Aucune √©quipe pour le moment.</td></tr>`;

    waitBody.innerHTML = wait.length
      ? wait.map((r,i) => rowHtml(main.length + i + 1, r)).join("")
      : `<tr><td colspan="5" class="muted" style="padding:14px;">Aucune √©quipe en liste d‚Äôattente.</td></tr>`;

    const ranked = [...main];
    ranked.sort((a,b)=>{
      const a1 = toNum(a.p1Rank), a2 = toNum(a.p2Rank);
      const b1 = toNum(b.p1Rank), b2 = toNum(b.p2Rank);
      const at = (a1 !== null && a2 !== null) ? (a1+a2) : Number.POSITIVE_INFINITY;
      const bt = (b1 !== null && b2 !== null) ? (b1+b2) : Number.POSITIVE_INFINITY;
      if(at !== bt) return at - bt;
      return (a.createdAtMs||0) - (b.createdAtMs||0);
    });

    rankedCountEl.textContent = ranked.length;

    rankedBody.innerHTML = ranked.length
      ? ranked.map((r,i) => rowRankedHtml(i+1, r)).join("")
      : `<tr><td colspan="5" class="muted" style="padding:14px;">Aucune √©quipe sur la liste principale.</td></tr>`;
  }

  function showInscrits(){
    tabInscrits.setAttribute("aria-selected", "true");
    tabClassees.setAttribute("aria-selected", "false");
    panelInscrits.style.display = "block";
    panelClassees.style.display = "none";
    try{ localStorage.setItem(LS_KEY, "inscrits"); }catch(e){}
  }
  function showClassees(){
    tabInscrits.setAttribute("aria-selected", "false");
    tabClassees.setAttribute("aria-selected", "true");
    panelInscrits.style.display = "none";
    panelClassees.style.display = "block";
    try{ localStorage.setItem(LS_KEY, "classees"); }catch(e){}
  }

  tabInscrits.addEventListener("click", showInscrits);
  tabClassees.addEventListener("click", showClassees);

  try{
    const saved = localStorage.getItem(LS_KEY);
    if(saved === "classees") showClassees(); else showInscrits();
  }catch(e){
    showInscrits();
  }

  const q = query(collection(db, COL_PUBLIC), orderBy("createdAt", "asc"));

  onSnapshot(q, (snap) => {
    const rows = [];
    snap.forEach(docSnap => {
      const d = docSnap.data() || {};
      rows.push({
        id: docSnap.id,
        teamName: d.teamName || "",
        p1FirstName: d.p1FirstName || "",
        p2FirstName: d.p2FirstName || "",
        createdAtMs: d.createdAt?.toMillis ? d.createdAt.toMillis() : 0,
        list: d.list || null,
        stby: d.stby === true,
        p1Rank: d.p1Rank ?? null,
        p2Rank: d.p2Rank ?? null
      });
    });

    render(rows);
    statusEl.textContent = "üü¢ En direct";
  }, (err) => {
    console.error(err);
    statusEl.textContent = "üî¥ Erreur de connexion";
  });
</script>

</body>
</html>
