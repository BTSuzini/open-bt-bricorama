<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inscriptions â€” Double Dames â€” Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        Open BT Bricorama<br>
        <span style="opacity:.95;font-weight:800;">Double Dames</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="programmation.html">Programmation</a>
      <a href="equipes.html">Ã‰quipes</a>
      <a href="inscriptions.html" aria-current="page">Inscriptions</a>
      <a href="tirage.html">Tirage</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="cardForm">
    <h2>ğŸ“ Formulaire dâ€™inscription â€” Double Dames</h2>
    <p id="gateMsg" class="muted">Chargementâ€¦</p>

    <form id="signupForm" class="form" autocomplete="on">

      <div class="field">
        <label for="teamName">Nom de lâ€™Ã©quipe *</label>
        <input id="teamName" name="teamName" type="text" required maxlength="40" placeholder="Ex : Les beacheuses">
      </div>

      <hr class="sep" />

      <h3 style="margin:0;">Joueuse 1 ğŸ‘©</h3>

      <div class="field">
        <label for="p1LastName">Nom *</label>
        <input id="p1LastName" name="p1LastName" type="text" required placeholder="Nom">
      </div>

      <div class="field">
        <label for="p1FirstName">PrÃ©nom *</label>
        <input id="p1FirstName" name="p1FirstName" type="text" required placeholder="PrÃ©nom">
      </div>

      <div class="field">
        <label for="p1Licence">NÂ° Licence *</label>
        <input id="p1Licence" name="p1Licence" type="text" required placeholder="Ex : 0123456A">
      </div>

      <div class="field">
        <label for="p1Phone">TÃ©lÃ©phone *</label>
        <input id="p1Phone" name="p1Phone" type="tel" required placeholder="Ex : +594... / 06...">
      </div>

      <hr class="sep" />

      <h3 style="margin:0;">Joueuse 2 ğŸ‘©</h3>

      <div class="field">
        <label for="p2LastName">Nom *</label>
        <input id="p2LastName" name="p2LastName" type="text" required placeholder="Nom">
      </div>

      <div class="field">
        <label for="p2FirstName">PrÃ©nom *</label>
        <input id="p2FirstName" name="p2FirstName" type="text" required placeholder="PrÃ©nom">
      </div>

      <div class="field">
        <label for="p2Licence">NÂ° Licence *</label>
        <input id="p2Licence" name="p2Licence" type="text" required placeholder="Ex : 0123456A">
      </div>

      <div class="field">
        <label for="p2Phone">TÃ©lÃ©phone *</label>
        <input id="p2Phone" name="p2Phone" type="tel" required placeholder="Ex : +594... / 06...">
      </div>

      <hr class="sep" />

      <button id="submitBtn" class="btn" type="submit" style="font-weight:900; color:#111;">
        âœ… Valider
      </button>

      <p id="status" class="muted" role="status" aria-live="polite"></p>
    </form>
  </section>

  <section class="card" id="cardSuccess" style="display:none;">
    <h2>âœ… Inscription enregistrÃ©e</h2>
    <p class="muted">Merci pour votre inscription ğŸ™Œ</p>
    <div class="grid" style="margin-top:12px;">
      <a class="btn" href="equipes.html">ğŸ‘¥ Voir les Ã©quipes</a>
      <a class="btn" href="programmation.html">ğŸ“… Programmation</a>
    </div>
  </section>

</main>

<script type="module">
  import { db } from "../assets/js/firebase.js";
  import {
    doc, onSnapshot,
    collection, addDoc, setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Open BT â€” DD
  const COL_PRIVATE = "inscriptions_dd_private";
  const COL_PUBLIC  = "equipes_dd_public";

  // Gate unique Open BT : config/open (champ exact Firestore)
  const CFG_FIELD = "inscriptionsDDState"; // <- ton champ Firestore

  const cardForm = document.getElementById("cardForm");
  const cardSuccess = document.getElementById("cardSuccess");

  const form = document.getElementById("signupForm");
  const statusEl = document.getElementById("status");
  const gateMsgEl = document.getElementById("gateMsg");
  const submitBtn = document.getElementById("submitBtn");

  let gateState = "not_open"; // open | paused | closed | not_open
  let isSubmitting = false;   // anti double-clic / double submit

  const setStatus = (msg) => { statusEl.textContent = msg; };

  function normalizeState(state){
    if(state === "suspended") return "paused";
    return state || "not_open";
  }

  function showSuccess(){
    // Cache tout le formulaire aprÃ¨s validation confirmÃ©e
    cardForm.style.display = "none";
    cardSuccess.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function applyGate(stateRaw){
    gateState = normalizeState(stateRaw);

    if(gateState === "open"){
      gateMsgEl.textContent = "âœ… Inscriptions ouvertes. Tu peux tâ€™inscrire ci-dessous.";
      submitBtn.disabled = false;
      submitBtn.classList.remove("disabled");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.classList.add("disabled");

    if(gateState === "paused"){
      gateMsgEl.textContent = "â¸ï¸ Inscriptions temporairement suspendues. RÃ©essaie un peu plus tard.";
      return;
    }
    if(gateState === "closed"){
      gateMsgEl.textContent = "ğŸ”’ Inscriptions clÃ´turÃ©es.";
      return;
    }
    gateMsgEl.textContent = "â³ Les inscriptions ne sont pas encore ouvertes.";
  }

  // ğŸ”„ Live gate (config/open)
  onSnapshot(doc(db, "config", "open"), (snap)=>{
    const d = snap.exists() ? (snap.data() || {}) : {};
    applyGate(d[CFG_FIELD] || "not_open");
  }, (err)=>{
    console.error(err);
    applyGate("not_open");
    gateMsgEl.textContent = "âŒ Impossible de vÃ©rifier lâ€™Ã©tat des inscriptions. RÃ©essaie plus tard.";
  });

  function readFormData(){
    return {
      createdAt: serverTimestamp(),
      teamName: (form.teamName.value || "").trim(),

      p1FirstName: (form.p1FirstName.value || "").trim(),
      p1LastName:  (form.p1LastName.value || "").trim(),
      p1Licence:   (form.p1Licence.value || "").trim(),
      p1Phone:     (form.p1Phone.value || "").trim(),

      p2FirstName: (form.p2FirstName.value || "").trim(),
      p2LastName:  (form.p2LastName.value || "").trim(),
      p2Licence:   (form.p2Licence.value || "").trim(),
      p2Phone:     (form.p2Phone.value || "").trim(),
    };
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if(isSubmitting) return;

    if(gateState !== "open"){
      setStatus("â›” Inscriptions non ouvertes.");
      return;
    }

    isSubmitting = true;
    submitBtn.disabled = true;
    submitBtn.classList.add("disabled");
    setStatus("Envoi en coursâ€¦");

    try {
      const data = readFormData();

      if (!data.teamName || !data.p1FirstName || !data.p1LastName || !data.p2FirstName || !data.p2LastName) {
        throw new Error("Merci de complÃ©ter tous les champs obligatoires.");
      }

      // 1) PRIVÃ‰ (doc auto-id)
      const ref = await addDoc(collection(db, COL_PRIVATE), data);

      // 2) PUBLIC (mÃªme ID)
      await setDoc(doc(db, COL_PUBLIC, ref.id), {
        createdAt: serverTimestamp(),
        teamName: data.teamName,
        p1FirstName: data.p1FirstName,
        p2FirstName: data.p2FirstName,
        list: "main",
        stby: false
      });

      // reset immÃ©diat (au cas oÃ¹), puis popup, puis on cache la page
      form.reset();

      const recap =
        `âœ… Inscription enregistrÃ©e !\n\n` +
        `Ã‰quipe : ${data.teamName}\n` +
        `Joueuses : ${data.p1FirstName} ${data.p1LastName} & ${data.p2FirstName} ${data.p2LastName}`;

      alert(recap);

      // AprÃ¨s fermeture du popup : on retire le formulaire
      showSuccess();
      setStatus("");

    } catch (err) {
      console.error(err);
      setStatus("âŒ Erreur : " + (err?.message || "Impossible dâ€™enregistrer lâ€™inscription."));
      // si erreur, on rÃ©-autorise
      if(gateState === "open"){
        submitBtn.disabled = false;
        submitBtn.classList.remove("disabled");
      }
    } finally {
      isSubmitting = false;
    }
  });
</script>

</body>
</html>
