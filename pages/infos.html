<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infos ‚Äî Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260220" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">Open BT Bricorama</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT Bricorama">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>

      <!-- ‚úÖ pas d'index DH/DD => redirection vers programmation -->
      <a href="../dh/programmation.html">DM</a>
      <a href="../dd/programmation.html">DD</a>

      <a href="infos.html" aria-current="page">Infos</a>
      <a href="reglement.html">R√®glement</a>
      <a href="repas.html">Repas</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Public: fil d'infos -->
  <section class="card">
    <h2 style="margin:0 0 10px 0;">üì∞ Derni√®res infos</h2>
    <p class="muted" style="margin-top:0;">
      Retrouvez ici les derni√®res annonces de l‚Äôorganisation (Open BT Bricorama).
    </p>

    <!-- Compteur / statut -->
    <p class="muted" id="infosCount" style="margin:10px 0 0;">Chargement‚Ä¶</p>

    <!-- Liste -->
    <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

</main>

<script type="module">
  import { db } from "../assets/js/firebase.js";
  import {
    collection,
    query,
    orderBy,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ Collection Open BT
  const COL_INFOS = "infos";

  // DOM
  const infosList  = document.getElementById("infosList");
  const infosCount = document.getElementById("infosCount");

  function escapeHTML(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", {
        year:"numeric", month:"long", day:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
    } catch {
      return "‚Äî";
    }
  }

  function renderInfos(items){
    infosList.innerHTML = "";
    infosCount.textContent = `üìå ${items.length} info${items.length > 1 ? "s" : ""}`;

    if(items.length === 0){
      infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info pour le moment.</p>`;
      return;
    }

    for(const it of items){
      const title = escapeHTML(it.title);
      const text  = escapeHTML(it.text).replaceAll("\n","<br>");
      const date  = fmtDate(it.createdAt);

      const card = document.createElement("div");
      card.className = "card";
      card.style.margin = "0";

      card.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <div style="font-weight:900;">${title}</div>
          <div class="muted" style="margin:0;">üóìÔ∏è ${date}</div>
          <div style="margin-top:2px; line-height:1.45;">${text}</div>
        </div>
      `;

      infosList.appendChild(card);
    }
  }

  // üîÑ Flux live (plus r√©cent en haut)
  infosCount.textContent = "Chargement‚Ä¶";
  const q = query(collection(db, COL_INFOS), orderBy("createdAt", "desc"));

  onSnapshot(q, (snap) => {
    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInfos(items);
  }, (err) => {
    console.error(err);
    infosCount.textContent = "‚ùå Impossible de charger les infos.";
  });
</script>

</body>
</html>
