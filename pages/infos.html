<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infos ‚Äî Open BT Bricorama</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260219" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">Open BT Bricorama</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-openbt.png" alt="Logo Open BT Bricorama">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="dh/index.html">DM</a>
      <a href="dd/index.html">DD</a>
      <a href="infos.html" aria-current="page">Infos</a>
      <a href="reglement.html">R√®glement</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Admin: ajout d'infos (affich√© uniquement si r√¥le = admin) -->
  <section class="card" id="adminBox" style="display:none;">
    <h2 style="margin:0 0 10px 0;">üõ†Ô∏è Admin ‚Äî Publier une info</h2>

    <form id="infoForm" class="form" autocomplete="off">
      <div class="field">
        <label for="infoTitle">Titre *</label>
        <input id="infoTitle" name="infoTitle" type="text" required maxlength="80"
               placeholder="Ex : Inscriptions ouvertes ‚úÖ">
      </div>

      <div class="field">
        <label for="infoText">Texte *</label>
        <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
                  placeholder="√âcris ici le message (emojis ok üòÑ)"></textarea>
      </div>

      <button id="publishBtn" class="btn" type="submit" style="font-weight:800; color:#111;">
        üì£ Publier
      </button>

      <p id="adminStatus" class="muted" role="status" aria-live="polite" style="margin:8px 0 0;"></p>
    </form>

    <p class="muted" style="margin-top:10px;">
      Les infos apparaissent automatiquement c√¥t√© public (plus r√©cent en haut).
    </p>
  </section>

  <!-- Public: fil d'infos -->
  <section class="card">
    <h2 style="margin:0 0 10px 0;">üì∞ Derni√®res infos</h2>
    <p class="muted" style="margin-top:0;">
      Retrouvez ici les derni√®res annonces de l‚Äôorganisation (Open BT Bricorama).
    </p>

    <!-- Compteur / statut -->
    <p class="muted" id="infosCount" style="margin:10px 0 0;">Chargement‚Ä¶</p>

    <!-- Liste -->
    <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

</main>

<script type="module">
  // ‚úÖ M√™me pattern que le challenge (pas de config Firebase ici)
  import { auth, db } from "../assets/js/firebase.js";
  import { getRoleByEmail } from "../assets/js/session.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection,
    addDoc,
    deleteDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // üîß Collection des infos (Open)
  // üëâ Recommandation "future proof": utiliser une collection d√©di√©e :
  //    infos_openbt
  // (comme √ßa, z√©ro risque de m√©langer avec le challenge)
  const COL_INFOS = "infos_openbt";

  // DOM
  const infosList  = document.getElementById("infosList");
  const infosCount = document.getElementById("infosCount");

  const adminBox    = document.getElementById("adminBox");
  const infoForm    = document.getElementById("infoForm");
  const publishBtn  = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");

  let isAdmin = false;

  function escapeHTML(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", {
        year:"numeric", month:"long", day:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
    } catch {
      return "‚Äî";
    }
  }

  function renderInfos(items){
    infosList.innerHTML = "";
    infosCount.textContent = `üìå ${items.length} info${items.length > 1 ? "s" : ""}`;

    if(items.length === 0){
      infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info pour le moment.</p>`;
      return;
    }

    for(const it of items){
      const title = escapeHTML(it.title);
      const text  = escapeHTML(it.text).replaceAll("\n","<br>");
      const date  = fmtDate(it.createdAt);

      const card = document.createElement("div");
      card.className = "card";
      card.style.margin = "0";

      const adminActions = isAdmin ? `
        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">
            üóëÔ∏è Supprimer
          </button>
        </div>
      ` : "";

      card.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <div style="font-weight:900;">${title}</div>
          <div class="muted" style="margin:0;">üóìÔ∏è ${date}</div>
          <div style="margin-top:2px; line-height:1.45;">${text}</div>
          ${adminActions}
        </div>
      `;

      infosList.appendChild(card);
    }

    if(isAdmin){
      infosList.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          const ok = confirm("Supprimer cette info ?\n\n‚ö†Ô∏è Action irr√©versible.");
          if(!ok) return;

          try{
            await deleteDoc(doc(db, COL_INFOS, id));
            alert("Info supprim√©e ‚úÖ");
          } catch(e){
            console.error(e);
            alert("Erreur suppression ‚ùå");
          }
        });
      });
    }
  }

  // üîê D√©tection admin
  onAuthStateChanged(auth, async (user) => {
    adminBox.style.display = "none";
    isAdmin = false;

    if(!user) return;

    try{
      const role = await getRoleByEmail(user.email);
      if(role === "admin"){
        isAdmin = true;
        adminBox.style.display = "block";
      }
    } catch(e){
      console.warn("Role lookup failed:", e);
    }
  });

  // üîÑ Flux live (plus r√©cent en haut)
  infosCount.textContent = "Chargement‚Ä¶";
  const q = query(collection(db, COL_INFOS), orderBy("createdAt", "desc"));

  onSnapshot(q, (snap) => {
    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInfos(items);
  }, (err) => {
    console.error(err);
    infosCount.textContent = "‚ùå Impossible de charger les infos.";
  });

  // üõ†Ô∏è Publication (admin)
  infoForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publication en cours‚Ä¶";

    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text  = (infoForm.infoText.value || "").trim();

      if(!title || !text){
        throw new Error("Titre et texte obligatoires.");
      }

      await addDoc(collection(db, COL_INFOS), {
        title,
        text,
        createdAt: serverTimestamp()
      });

      infoForm.reset();
      adminStatus.textContent = "‚úÖ Info publi√©e !";
    } catch(err){
      console.error(err);
      adminStatus.textContent = "‚ùå Erreur : " + (err?.message || "publication impossible.");
    } finally {
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });
</script>

</body>
</html>
